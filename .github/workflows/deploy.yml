name: Deploy to AWS Amplify

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: 🚀 Deploy Frontend to Amplify
    runs-on: ubuntu-latest

    env:
      AWS_REGION: us-east-1
      AWS_DEFAULT_REGION: us-east-1
      AMPLIFY_APP_NAME: my-amplify-app
      OUTPUT_FOLDER: dist

    steps:
      - name: 📦 Checkout repository
        uses: actions/checkout@v3

      - name: 🛠️ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: 📦 Install dependencies
        run: npm install

      - name: 🔧 Build app
        run: npm run build

      - name: 📡 Get or create Amplify App
        id: amplify
        run: |
          echo "🔍 Checking for Amplify App..."
          APP_ID=$(aws amplify list-apps --query "apps[?name=='$AMPLIFY_APP_NAME'].appId" --output text)
          
          if [ -z "$APP_ID" ]; then
            echo "⚠️ Amplify app '$AMPLIFY_APP_NAME' not found."
            echo "❗ You must first create the app and connect the 'main' branch manually in the AWS Amplify Console."
            exit 1
          else
            echo "✅ Amplify App found."
          fi

          echo "AMPLIFY_APP_ID=$APP_ID" >> $GITHUB_ENV
          echo "✅ App ID: $APP_ID"

        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - name: 🚀 Trigger Deploy on Amplify
        run: |
          echo "📡 Triggering Amplify deploy..."
          aws amplify start-job \
            --app-id $AMPLIFY_APP_ID \
            --branch-name main \
            --job-type RELEASE \
            --job-reason "Triggered by GitHub Action"

        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AMPLIFY_APP_ID: ${{ env.AMPLIFY_APP_ID }}
