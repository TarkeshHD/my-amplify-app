name: Deploy to AWS Amplify

on:
  push:
    branches: [main]

jobs:
  deploy:
    name: üöÄ Deploy to Amplify
    runs-on: ubuntu-latest

    env:
      AWS_REGION: us-east-1
      AWS_DEFAULT_REGION: us-east-1
      AMPLIFY_APP_NAME: my-amplify-app
      OUTPUT_FOLDER: dist

    steps:
    - name: ‚¨áÔ∏è Checkout Repo
      uses: actions/checkout@v3

    - name: ‚òÅÔ∏è Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: üîç Check or Create Amplify App
      id: amplifyapp
      run: |
        echo "üîç Checking for Amplify App..."
        APP_ID=$(aws amplify list-apps --query "apps[?name=='$AMPLIFY_APP_NAME'].appId" --output text)

        if [ -z "$APP_ID" ]; then
          echo "üöÄ Creating Amplify App..."
          APP_ID=$(aws amplify create-app \
            --name "$AMPLIFY_APP_NAME" \
            --repository "https://github.com/${{ github.repository }}" \
            --oauth-token "${{ secrets.GH_PAT }}" \
            --query 'app.appId' \
            --output text)

          echo "üîß Connecting 'main' branch..."
          aws amplify create-branch \
            --app-id "$APP_ID" \
            --branch-name "main" \
            --framework "Web" \
            --stage "PRODUCTION"
        else
          echo "‚úÖ Amplify App already exists."
        fi

        echo "AMPLIFY_APP_ID=$APP_ID" >> $GITHUB_ENV
        echo "‚úÖ App ID: $APP_ID"

    - name: üåê Add Custom Domain (optional)
      if: env.CUSTOM_DOMAIN != ''
      run: |
        echo "üåê Adding custom domain: $CUSTOM_DOMAIN"
        aws amplify create-domain-association \
          --app-id $AMPLIFY_APP_ID \
          --domain-name $CUSTOM_DOMAIN \
          --sub-domain-settings "[{\"prefix\":\"www\",\"branchName\":\"main\"}]"
      env:
        CUSTOM_DOMAIN: ${{ secrets.CUSTOM_DOMAIN }}

    - name: üì° Trigger Amplify Deploy
      run: |
        echo "üì° Triggering Amplify deploy..."
        aws amplify start-job \
          --app-id $AMPLIFY_APP_ID \
          --branch-name main \
          --job-type RELEASE \
          --job-reason "Triggered by GitHub Action"
